<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-v0.2.0/tutorials/ipsec-network" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">IPsec Cross-cluster Network | Kosmos</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://kosmos-io.github.io/website/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://kosmos-io.github.io/website/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://kosmos-io.github.io/website/v0.2.0/tutorials/ipsec-network"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="IPsec Cross-cluster Network | Kosmos"><meta data-rh="true" name="description" content="Using IPsec Tunnels for Cross-Cluster Container Network Communication over Public IP"><meta data-rh="true" property="og:description" content="Using IPsec Tunnels for Cross-Cluster Container Network Communication over Public IP"><link data-rh="true" rel="icon" href="/website/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://kosmos-io.github.io/website/v0.2.0/tutorials/ipsec-network"><link data-rh="true" rel="alternate" href="https://kosmos-io.github.io/website/v0.2.0/tutorials/ipsec-network" hreflang="en"><link data-rh="true" rel="alternate" href="https://kosmos-io.github.io/website/v0.2.0/tutorials/ipsec-network" hreflang="x-default"><link rel="stylesheet" href="/website/assets/css/styles.281b787e.css">
<script src="/website/assets/js/runtime~main.ed4335b8.js" defer="defer"></script>
<script src="/website/assets/js/main.253a6bbd.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/website/"><div class="navbar__logo"><img src="/website/img/logo.svg" alt="Kosmos Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/website/img/logo.svg" alt="Kosmos Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Kosmos</b></a></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/website/v0.2.0/getting-started/introduction">Documentation</a><a class="navbar__item navbar__link" href="/website/blog">Examples</a><a href="https://github.com/kosmos-io/kosmos" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/website/v0.2.0/getting-started/introduction">Getting Started</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website/v0.2.0/getting-started/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website/v0.2.0/quick-start">Quick Start</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/website/v0.2.0/tutorials/mcs-discovery">Tutorials</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website/v0.2.0/tutorials/mcs-discovery">Multi-cluster Service Discovery</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website/v0.2.0/tutorials/mc-scheduler">Multi-cluster Scheduler</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website/v0.2.0/tutorials/node-not-ready">Kosmos Node NotReady</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/website/v0.2.0/tutorials/ipsec-network">IPsec Cross-cluster Network</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/website/v0.2.0/proposals/k8s-in-k8s">Proposals</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website/v0.2.0/proposals/k8s-in-k8s">Kubernetes in Kubernetes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website/v0.2.0/proposals/distribution-policy">Distribution Policy</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/website/v0.2.0/proposals/leaf-node-generate-rules">Leaf Node Generate Rules</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/website/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Tutorials</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">IPsec Cross-cluster Network</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>IPsec Cross-cluster container network solution</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-ipsec-tunnels-for-cross-cluster-container-network-communication-over-public-ip">Using IPsec Tunnels for Cross-Cluster Container Network Communication over Public IP<a href="#using-ipsec-tunnels-for-cross-cluster-container-network-communication-over-public-ip" class="hash-link" aria-label="Direct link to Using IPsec Tunnels for Cross-Cluster Container Network Communication over Public IP" title="Direct link to Using IPsec Tunnels for Cross-Cluster Container Network Communication over Public IP">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a href="#introduction" class="hash-link" aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h3>
<p>Kosmos is a multi-cluster solution, and networking is an essential part of it.
Sometimes, there is a need for communication between Kubernetes clusters in different networks.
In some cases, two or more clusters can only communicate with each other over the public internet.
To address this, Kosmos has implemented a cross-cluster container network communication solution based on IPsec tunnels.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="motivation">Motivation<a href="#motivation" class="hash-link" aria-label="Direct link to Motivation" title="Direct link to Motivation">​</a></h3>
<p>For the sake of disaster recovery, application deployments may require communication across different clouds or across regions within a single cloud (across VPCs).
In such scenarios, container communication becomes challenging as the internal IP addresses of the machines are usually not directly accessible without a dedicated network connection.
Common CNI tunnel technologies like <code>VxLAN</code> or <code>IPIP</code> may not work effectively in public internet environments.
To solve this problem, Kosmos has implemented a container network communication solution based on IPsec tunnels for cross-cloud communication over the public internet.
This solution addresses the need for communication across public networks while also considering data transmission security.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="goals">Goals<a href="#goals" class="hash-link" aria-label="Direct link to Goals" title="Direct link to Goals">​</a></h3>
<p>The goal is to enable communication between pods in two clusters using elastic public IP addresses. The flow of traffic is illustrated in the diagram below:</p>
<p><img decoding="async" loading="lazy" alt="IPsec_Tunnel" src="/website/assets/images/IPsec_Tunnel-9f261fc88ef5a03937ab257a45539388.jpeg" width="1301" height="331" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>NOTE</div><div class="admonitionContent_BuS1"><p>This solution does not address container network communication in host network mode within a cluster.
Only focuses on IPv4 container network communication and does not cover IPv6 container networks.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="design-details">Design Details<a href="#design-details" class="hash-link" aria-label="Direct link to Design Details" title="Direct link to Design Details">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="api-changes">API Changes<a href="#api-changes" class="hash-link" aria-label="Direct link to API Changes" title="Direct link to API Changes">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="cluster-api-changes">Cluster API Changes<a href="#cluster-api-changes" class="hash-link" aria-label="Direct link to Cluster API Changes" title="Direct link to Cluster API Changes">​</a></h4>
<p>This solution adds three fields to the <code>.spec.ClusterLinkOptions</code>: <code>NodeElasticIPMap</code>, <code>ClusterPodCIDRs</code>, and <code>UseExternalApiserver</code>.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type ClusterLinkOptions struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // NodeElasticIPMap presents mapping between nodename in kubernetes and elasticIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // +optional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NodeElasticIPMap map[string]string `json:&quot;nodeElasticIPMap,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // +optional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClusterPodCIDRs []string `json:&quot;clusterpodCIDRs,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // +optional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    UseExternalApiserver bool `json:&quot;useexternalapiserver,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><code>NodeElasticIPMap</code> field represents the mapping relationship between the NodeName in Kubernetes and the elastic public IP mounted on the node.</li>
<li><code>ClusterPodCIDRs</code> field is added to input the Pod CIDR, as it is not always easy to obtain the Pod CIDR for some CNI plugins.</li>
</ul>
<p>Typically, Kosmos retrieves the service CIDR through the kube-apiserver parameters. However, in some cases, the kube-apiserver is not a pod within the cluster. Therefore, the <code>UseExternalApiserver</code> field is added to handle this scenario.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="clusternode-api-changes">Clusternode API Changes<a href="#clusternode-api-changes" class="hash-link" aria-label="Direct link to Clusternode API Changes" title="Direct link to Clusternode API Changes">​</a></h4>
<p>This solution adds a new field, <code>ElasticIP</code>, to the <code>.spec</code>, and a new field, <code>NodeStatus</code>, to the <code>.status</code>.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type ClusterNodeSpec struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // +optional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ElasticIP string `json:&quot;elasticip,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type ClusterNodeStatus struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // +optional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NodeStatus string `json:&quot;nodeStatus,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><code>ElasticIP</code> field describes the elastic public IP mounted on the node.</li>
<li><code>NodeStatus</code> field describes the status of the node, either &quot;Ready&quot; or &quot;NotReady&quot;.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="nodeconfig-api-changes">Nodeconfig API Changes<a href="#nodeconfig-api-changes" class="hash-link" aria-label="Direct link to Nodeconfig API Changes" title="Direct link to Nodeconfig API Changes">​</a></h4>
<p>This solution adds two new fields, <code>XfrmPoliciesXfrmStates</code> and <code>IPsetsAvoidMasqs</code>, to the <code>.spec</code>.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type NodeConfigSpec struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    XfrmPolicies     []XfrmPolicy `json:&quot;xfrmpolicies,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    XfrmStates       []XfrmState  `json:&quot;xfrmstates,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IPsetsAvoidMasqs []IPset      `json:&quot;ipsetsavoidmasq,omitempty&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type XfrmPolicy struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LeftIP   string `json:&quot;leftip&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LeftNet  string `json:&quot;leftnet&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RightIP  string `json:&quot;rightip&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RightNet string `json:&quot;rightnet&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ReqID    int    `json:&quot;reqid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Dir      int    `json:&quot;dir&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type XfrmState struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LeftIP  string `json:&quot;leftip&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RightIP string `json:&quot;rightip&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ReqID   int    `json:&quot;reqid&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SPI     uint32 `json:&quot;spi&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PSK     string `json:&quot;PSK&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">type IPset struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CIDR string `json:&quot;cidr&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Name string `json:&quot;name&quot;`</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The new <code>XfrmPolicies</code> and <code>XfrmStates</code> fields define the IPsec-related rules created by Kosmos.</p>
<p><code>IPsetsAvoidMasqs</code> field describes the network segments that need to avoid masquerading, allowing outbound traffic from containers to retain their container IP address.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="component-modifications">Component Modifications<a href="#component-modifications" class="hash-link" aria-label="Direct link to Component Modifications" title="Direct link to Component Modifications">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="clusterlink-controller-manager">Clusterlink-controller-manager<a href="#clusterlink-controller-manager" class="hash-link" aria-label="Direct link to Clusterlink-controller-manager" title="Direct link to Clusterlink-controller-manager">​</a></h4>
<p>Handling scenarios where kube-apiserver pods are not within the cluster:</p>
<ul>
<li>The cluster-controller optimizes the retrieval of service CIDR through the <code>GetSvcByCreateInvalidSvc</code> function.</li>
</ul>
<p>Node status synchronization:</p>
<ul>
<li>The node-controller synchronizes the <code>ElasticIP</code> field of the <code>clusternode</code> object based on the values in the <code>NodeElasticIPMap</code> field of the <code>cluster</code> object.</li>
<li>The node-controller now updates the <code>.Status.NodeStatus</code> field of the <code>clusternode</code> object based on the node&#x27;s status, &quot;Ready&quot; or &quot;NotReady&quot;.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="clusterlink-elector">Clusterlink-elector<a href="#clusterlink-elector" class="hash-link" aria-label="Direct link to Clusterlink-elector" title="Direct link to Clusterlink-elector">​</a></h4>
<p>The elector module is used for <code>Gateway</code> selection in Gateway mode. It can now select a <code>Gateway</code> from the nodes in &quot;Ready&quot; state.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="clusterlink-network-manager">Clusterlink-network-manager<a href="#clusterlink-network-manager" class="hash-link" aria-label="Direct link to Clusterlink-network-manager" title="Direct link to Clusterlink-network-manager">​</a></h4>
<ol>
<li>
<p>Adding support for some CNI plugins
For some CNI plugins, iptables rules are added to avoid masquerading, allowing outbound traffic from containers to retain their container IP address.</p>
</li>
<li>
<p>Building IPsec rules
Typically, Kosmos creates routes to achieve container communication. In IPsec tunnel mode, Kosmos creates <code>ip xfrm state</code> and <code>ip xfrm policy</code> rules if the <code>ElasticIP</code> field of the <code>clusternode</code> is not empty.</p>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="clusterlink-agent">clusterlink-agent<a href="#clusterlink-agent" class="hash-link" aria-label="Direct link to clusterlink-agent" title="Direct link to clusterlink-agent">​</a></h4>
<p>Functions have been added to execute specific operations, equivalent to executing <code>ip xfrm state add/del</code> and <code>ip xfrm policy add/del</code> commands on the operating system.</p>
<p>To avoid masquerading, functions have been added to execute <code>ipset</code> commands and create iptables rules.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="kosmosctl">kosmosctl<a href="#kosmosctl" class="hash-link" aria-label="Direct link to kosmosctl" title="Direct link to kosmosctl">​</a></h4>
<p><code>NodeElasticIP</code>, <code>UseExternalApiserver</code>, and <code>ClusterPodCIDRs</code> input parameters have been added to populate the new fields <code>NodeElasticIPMap</code>, <code>UseExternalApiserver</code>, and <code>ClusterPodCIDRs</code> in the <code>Cluster</code> CRD.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/v0.2.0/tutorials/ccn-ipsec-tunnel.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/website/v0.2.0/tutorials/node-not-ready"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Kosmos Node NotReady</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/website/v0.2.0/proposals/k8s-in-k8s"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Kubernetes in Kubernetes</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#using-ipsec-tunnels-for-cross-cluster-container-network-communication-over-public-ip" class="table-of-contents__link toc-highlight">Using IPsec Tunnels for Cross-Cluster Container Network Communication over Public IP</a><ul><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a></li><li><a href="#motivation" class="table-of-contents__link toc-highlight">Motivation</a></li><li><a href="#goals" class="table-of-contents__link toc-highlight">Goals</a></li></ul></li><li><a href="#design-details" class="table-of-contents__link toc-highlight">Design Details</a><ul><li><a href="#api-changes" class="table-of-contents__link toc-highlight">API Changes</a></li><li><a href="#component-modifications" class="table-of-contents__link toc-highlight">Component Modifications</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/website/v0.2.0/getting-started/introduction">Getting Started</a></li><li class="footer__item"><a class="footer__link-item" href="/website/v0.2.0/tutorials/mcs-discovery">Tutorials</a></li><li class="footer__item"><a class="footer__link-item" href="/website/v0.2.0/proposals/k8s-in-k8s">Proposals</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/kosmos-io/kosmos" target="_blank" rel="noopener noreferrer" class="footer__link-item">Community Address Name<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/kosmos-io/kosmos" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
</body>
</html>